<html>

<head>
<title>Cornell Software Map</title>
<link rel="stylesheet" href="leaflet/leaflet.css" />
<link rel="stylesheet" href="leaflet/awesomplete.css" />
<script src="leaflet/leaflet.js"></script>
<script src="leaflet/leaflet-omnivore.min.js"></script>
<script src="leaflet/awesomplete.min.js"></script>
<style>

h2 { margin:0 }

#search { width:20% ; float:left }
.awesomplete { z-index:99999 ; font-family: Arial ; font-size:80% }
.awesomplete input { width:20em }
.awesomplete mark { background:none ! important ; font-weight:bold }

#results li:hover { text-decoration:underline ; cursor:pointer ; color:#f80 }

#map { height: 90% }


.keywords { margin-top:1em }

</style>
</head>

<body>
<div id='search'>
  <h1>Public Computer Labs</h1>
  Search for software or location names: <input id='q' />
  <ul id='results'></ul>
</div>
<div id='map'></div>
<script>

var map = L.map('map').setMaxBounds([[42.41,-76.58],[42.49,-76.36]]);

var osm_bw = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  maxZoom: 18,
  minZoom: 13,
  opacity: 0.6,
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

var softwares = [];

var customLayer = L.geoJson(null, {
  onEachFeature: function (feature, layer) {
    // split keywords into array
    var keywords = feature.properties.keywords.split(',');
    //feature.properties.keywords = keywords;
    for (let i=0; i<keywords.length; i++) {
      var k = keywords[i];
      if (softwares.indexOf(k) < 0) {
        softwares.push(k);
      }
    }

    // set popup content
    var popup = '<h2>' + feature.properties.name1 + '</h2>';
    popup += '<div>' + feature.properties.description + '</div>';
    var hours = feature.properties.hours;
    if (hours.startsWith('http')) {
      hours = hours.replace(/(?!")(http\S+)/g, '<a href="$1">$1</a>');
    }
    
    popup += '<div>Hours: ' + hours + '</div>';
    popup += '<div class="keywords">' + keywords.join(' - ') + '</div>';
    layer.bindPopup(popup, {
      minWidth: 400
    });
  }
});

var csv = omnivore.csv(
  'labs.csv',
  { latfield: 'lat', lonfield: 'lon' },
  customLayer
)
.on('ready', function() {
  // prepare autocomplete search
  var q = document.getElementById('q');
  new Awesomplete(q, {
    list: softwares,
    minChars: 1,
    filter: function (text, qterm) {
      var re = new RegExp('\\b'+qterm, 'i');
      return text.match(re);
    },
    autoFirst: false
  });
  q.oninput = search;
  q.onkeyup = search;
  search();
  q.focus();
})
.addTo(map);;


function search() {
  var qterm = document.getElementById('q').value.trim();
  // we'll be searching for words that start with the user's query
  var re = new RegExp('\\b'+qterm, 'i');
  var keys = Object.keys(csv._layers);
  var results = document.getElementById('results');

  // reset results, close any popups
  results.innerHTML = '';
  map.closePopup();

  var bounds = L.latLngBounds(csv._layers[keys[0]]);
  for (var i=0; i<keys.length; i++) {
    var item = csv._layers[keys[i]];
    if (item.feature.properties.keywords.match(re) ||
        item.feature.properties.name1.match(re) ||
        item.feature.properties.name2.match(re)
      ) {
      item.addTo(map);
      var name = item.feature.properties.name1;
      var li = document.createElement('li');
      li.innerHTML = name;

      // expand bounds to include current point
      bounds.extend(item.getLatLng());

      // link to marker on map
      li.setAttribute('data', item._leaflet_id);
      li.onclick = function(e){
        var id = e.target.getAttribute('data')
        var item = map._layers[id].openPopup();
        map.panTo(item.getLatLng());
      }

      results.appendChild(li);
    }
    else {
      item.remove();
    }
  }
  // pad the bounds by 10% so that points aren't right on the edge of the map
  map.fitBounds(bounds.pad(0.1));
}

</script>

</body>
</html>
